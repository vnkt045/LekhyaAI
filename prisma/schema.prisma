// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Enums (mapped to string unions in TypeScript, but useful for DB constraints where supported, 
// though SQLite doesn't enforce enums natively, Prisma handles validation)

model User {
  id       String @id @default(cuid())
  name     String
  email    String @unique
  password String // Hashed
  role     String @default("user") // admin, accountant, viewer

  timesheets Timesheet[]
  companies  UserCompany[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// INVENTORY MANAGEMENT MODELS
// ============================================

model InventoryItem {
  id String @id @default(cuid())

  // Multi-Company Scope
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  code        String
  name        String
  description String?
  category    String // Raw Materials, Finished Goods, Trading Goods, etc.
  unit        String // pcs, kg, ltr, mtr, etc.
  hsnCode     String?
  gstRate     Float   @default(0)

  // Pricing
  purchaseRate Float
  saleRate     Float
  mrp          Float?

  // Stock Tracking
  openingStock Float @default(0)
  currentStock Float @default(0)
  reorderLevel Float @default(0)

  // Valuation Method
  valuationMethod String @default("FIFO") // FIFO, LIFO, Weighted Average

  // Relations
  movements    StockMovement[]
  voucherItems VoucherItem[]

  isActive Boolean @default(true)

  // Unit Conversion
  alternateUnit    String?
  conversionFactor Float? // e.g. 1 Box = 10 Pcs

  // Missing Relations (Fixed)
  stockGroupId String?
  stockGroup   StockGroup? @relation(fields: [stockGroupId], references: [id])

  uomId String?
  uom   UnitOfMeasure? @relation(fields: [uomId], references: [id])

  serialNumbers    SerialNumber[]
  bomFinishedItems BillOfMaterial[]    @relation("FinishedItem")
  bomComponents    BOMComponent[]      @relation("BOMComponentItem")
  transferItems    StockTransferItem[] @relation("TransferItems")
  batches          BatchTracking[]

  // Phase 1 Relations
  quoteItems         QuoteItem[]
  salesOrderItems    SalesOrderItem[]
  purchaseOrderItems PurchaseOrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, code])
  @@index([companyId])
}

model StockMovement {
  id     String        @id @default(cuid())
  itemId String
  item   InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  type     String // IN (Purchase/Production), OUT (Sale/Consumption), ADJUST (Stock Adjustment)
  quantity Float
  rate     Float
  amount   Float

  // Reference
  voucherId String?
  voucher   Voucher? @relation(fields: [voucherId], references: [id])

  referenceNo String?
  narration   String?
  date        DateTime

  // Godown/Location (for multi-location inventory)
  godownId String?
  godown   Godown? @relation(fields: [godownId], references: [id])

  // Batch Wise Details
  batchNumber       String?
  expiryDate        DateTime?
  manufacturingDate DateTime?

  createdAt DateTime @default(now())
}

// ============================================
// PAYROLL MODELS
// ============================================

// ============================================
// PAYROLL MODELS (Enhanced)
// ============================================

// ============================================

model PayHead {
  id String @id @default(cuid())

  // Multi-Company Scope
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name            String
  type            String // EARNINGS, DEDUCTIONS, REIMBURSEMENTS
  calculationType String // FLAT_RATE, ON_PRODUCTION, ON_ATTENDANCE, COMPUTED_VALUE

  // Ledger Integration
  ledgerName String? // Name of the account ledger this maps to (e.g. "Salary Expense")

  // For Computed Value
  formula String? // e.g., "(Basic + DA) * 12%" - simplified as string for now

  salaryDetails  EmployeeSalaryDetail[]
  payHeadEntries SalarySlipEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, name])
}

model EmployeeSalaryDetail {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  payHeadId String
  payHead   PayHead @relation(fields: [payHeadId], references: [id])

  amount        Float // The defined amount (e.g., 50000 Basic) or Rate
  effectiveFrom DateTime @default(now())

  @@unique([employeeId, payHeadId])
}

model AttendanceType {
  id String @id @default(cuid())

  // Multi-Company Scope
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name        String
  unitName    String // Days, Hours
  isLeave     Boolean @default(false) // Reduces salary?
  isPaidLeave Boolean @default(false) // Does not reduce salary

  entries AttendanceEntry[]

  @@unique([companyId, name])
}

model AttendanceEntry {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  typeId String
  type   AttendanceType @relation(fields: [typeId], references: [id])

  date  DateTime // Date of attendance
  value Float // 1 (day), 4 (hours) etc.

  createdAt DateTime @default(now())
}

// Updated Salary Slip to be dynamic
model SalarySlip {
  id String @id @default(cuid())

  // Multi-Company Scope is implicit via Employee, but explicit is safer for querying
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  month Int
  year  Int

  grossSalary     Float
  totalDeductions Float
  netSalary       Float

  entries SalarySlipEntry[]

  // Payment
  paidOn      DateTime?
  voucherId   String?
  voucher     Voucher?  @relation(fields: [voucherId], references: [id])
  paymentMode String?
  status      String    @default("PENDING")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, month, year])
  @@index([companyId])
}

model SalarySlipEntry {
  id     String     @id @default(cuid())
  slipId String
  slip   SalarySlip @relation(fields: [slipId], references: [id], onDelete: Cascade)

  payHeadId String
  payHead   PayHead @relation(fields: [payHeadId], references: [id])

  amount Float
  type   String // EARNINGS or DEDUCTIONS (snapshot from PayHead)
}

model Company {
  id                 String   @id @default(cuid())
  name               String
  gstin              String?
  pan                String?
  address            String
  city               String
  state              String
  pincode            String
  email              String
  phone              String
  financialYearStart DateTime
  financialYearEnd   DateTime
  baseCurrency       String   @default("INR")

  // Settings / Configuration
  voucherPrefix   String  @default("VCH")
  isAutoNumbering Boolean @default(true)
  dateFormat      String  @default("DD-MM-YYYY")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscription Subscription?

  // Relations to scoped entities
  users           UserCompany[]
  accounts        Account[]
  vouchers        Voucher[]
  inventoryItems  InventoryItem[]
  stockGroups     StockGroup[]
  godowns         Godown[]
  employees       Employee[]
  projects        Project[]
  voucherTypes    VoucherType[]
  payHeads        PayHead[]
  attendanceTypes AttendanceType[]
  salarySlips     SalarySlip[]
  tdsSections     TDSSection[]
  tcsConfigs      TCSConfig[]
  budgets         Budget[]

  unitOfMeasures UnitOfMeasure[]
  fixedAssets    FixedAsset[]
  costCategories CostCategory[]
  salaryStructures SalaryStructure[]
}

// New Join Model for User <-> Company
model UserCompany {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  role      String  @default("user") // admin, accountant, viewer
  isDefault Boolean @default(false) // If true, auto-select this company on login

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, companyId])
}

model Account {
  id String @id @default(cuid())

  // Multi-Company Scope
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  code String
  name String
  type String // Asset, Liability, Equity, Revenue, Expense

  // Self-relation for hierarchy (e.g., Current Assets -> Bank Accounts)
  parentId String?
  parent   Account?  @relation("AccountHierarchy", fields: [parentId], references: [id])
  children Account[] @relation("AccountHierarchy")

  balance             Float   @default(0.0)
  isActive            Boolean @default(true)
  isCostCenterEnabled Boolean @default(false)

  // Party Details (for Sundry Debtors/Creditors)
  email   String?
  phone   String?
  address String?
  gstin   String?
  pan     String?

  entries    VoucherEntry[]
  tdsEntries TDSEntry[]     @relation("TDSParty")
  tcsEntries TCSEntry[]     @relation("TCSParty")

  // Banking
  chequeBooks ChequeBook[]

  // Phase 1 Relations
  quotes         Quote[]
  salesOrders    SalesOrder[]
  purchaseOrders PurchaseOrder[]

  // Phase 2 Relations
  projects Project[]

  // Phase 3 Relations
  budgetEntries            BudgetEntry[]
  fixedAssets              FixedAsset[]  @relation("AssetAccount")
  depreciationExpenses     FixedAsset[]  @relation("DepreciationExpense")
  accumulatedDepreciations FixedAsset[]  @relation("AccumulatedDepreciation")

  // Phase 4 Relations
  portalUsers PortalUser[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, code])
  @@unique([companyId, name])
  @@index([companyId])
}

model VoucherType {
  id String @id @default(cuid())

  // Multi-Company Scope
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name            String
  abbreviation    String
  category        String // Payment, Receipt, Sales, Purchase, Contra, Journal, Other
  isSystemDefined Boolean @default(false)
  isActive        Boolean @default(true)

  // Numbering Configuration
  prefix         String?
  startingNumber Int     @default(1)

  // Behavior Settings
  affectsInventory Boolean @default(false)
  requiresGST      Boolean @default(false)
  taxRate          Float   @default(0) // If applicable

  projectExpenses ProjectExpense[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, name])
}

model Voucher {
  id String @id @default(cuid())

  // Multi-Company Scope
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  voucherNumber String
  voucherType   String // Payment, Receipt, Contra, Journal, Sales, Purchase
  date          DateTime

  totalDebit    Float
  totalCredit   Float
  narration     String
  invoiceNumber String? // Optional vendor invoice/bill reference

  // Multi-Currency Support
  currency     String @default("INR")
  exchangeRate Float  @default(1.0)

  // Relations
  entries     VoucherEntry[]
  gstDetails  GSTDetails?
  attachments Attachment[]
  aiInsights  AIInsight[]    @relation("VoucherInsights")

  createdBy   String // User ID placeholder
  isPosted    Boolean @default(false)
  isImmutable Boolean @default(false)

  // Post-Dated & Advanced Features
  isPostDated     Boolean   @default(false)
  pdcDate         DateTime?
  regularizedDate DateTime?

  isOptional  Boolean @default(false) // Memo voucher
  isRecurring Boolean @default(false) // Template

  stockMovements StockMovement[]
  salarySlips    SalarySlip[]
  items          VoucherItem[]
  tdsEntries     TDSEntry[]
  tcsEntries     TCSEntry[]

  // Banking
  chequeLeaf ChequeLeaf?

  // E-Way Bill
  ewayBills EWayBill[]

  // Manufacturing
  manufacturingJournals ManufacturingJournal[]

  // Phase 1: Order Management Relations
  quoteId        String?             @unique
  quote          Quote?              @relation("QuoteToInvoice", fields: [quoteId], references: [id])
  salesOrders    SalesOrderInvoice[]
  purchaseOrders PurchaseOrderBill[]

  // Phase 2 Relations
  timesheetEntries TimesheetEntry[]
  projectExpenses  ProjectExpense[]
  projectInvoices  ProjectInvoice[]

  // Phase 3 Relations
  depreciationEntries DepreciationEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt // Added for tracking

  // Multi-Company Indexing for Voucher
  @@unique([companyId, voucherNumber])
  @@index([companyId])
}

model VoucherEntry {
  id String @id @default(cuid())

  voucherId String
  voucher   Voucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  accountId   String
  account     Account @relation(fields: [accountId], references: [id])
  accountName String // Denormalized for easier querying if account deleted (though ideally keep referential integrity)

  debit  Float @default(0.0)
  credit Float @default(0.0)

  // Multi-Currency
  foreignAmount Float?

  // Cost Allocations (Many-to-One)
  allocations CostCenterAllocation[]

  narration String?

  // Banking
  bankReconciliation BankReconciliation?
  ProjectExpense     ProjectExpense[]
}

model CostCategory {
  id String @id @default(cuid())

  // Multi-Company Scope
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name               String
  allocateRevenue    Boolean      @default(true)
  allocateNonRevenue Boolean      @default(false)
  costCenters        CostCenter[]

  @@unique([companyId, name])
}

model CostCenter {
  id         String       @id @default(cuid())
  name       String
  categoryId String
  category   CostCategory @relation(fields: [categoryId], references: [id])

  // Hierarchy Support
  parentId String?
  parent   CostCenter?  @relation("CostCenterHierarchy", fields: [parentId], references: [id])
  children CostCenter[] @relation("CostCenterHierarchy")

  allocations CostCenterAllocation[]
}

model CostCenterAllocation {
  id             String       @id @default(cuid())
  voucherEntryId String
  voucherEntry   VoucherEntry @relation(fields: [voucherEntryId], references: [id], onDelete: Cascade)

  costCenterId String
  costCenter   CostCenter @relation(fields: [costCenterId], references: [id])

  amount Float // Amount allocated to this center

  createdAt DateTime @default(now())
}

model VoucherItem {
  id        String  @id @default(cuid())
  voucherId String
  voucher   Voucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  productName String
  description String?
  hsnSac      String?

  qty  Float   @default(0)
  rate Float   @default(0)
  per  String? // Unit (e.g. pcs, kg)

  taxableAmount Float @default(0) // qty * rate

  cgstRate   Float @default(0)
  cgstAmount Float @default(0)

  sgstRate   Float @default(0)
  sgstAmount Float @default(0)

  igstRate   Float @default(0)
  igstAmount Float @default(0)

  totalAmount Float @default(0) // taxable + taxes

  // Inventory Link
  inventoryItemId String?
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id])

  // Storage Location
  godownId String?
  godown   Godown? @relation(fields: [godownId], references: [id])
}

model GSTDetails {
  id String @id @default(cuid())

  voucherId String  @unique
  voucher   Voucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  gstin         String // Party's GSTIN
  gstType       String // CGST+SGST, IGST
  rate          Float
  taxableAmount Float

  // Individual tax components
  cgstAmount Float @default(0)
  sgstAmount Float @default(0)
  igstAmount Float @default(0)
  cessAmount Float @default(0)

  taxAmount Float // Total tax (for backward compatibility)
  totalGST  Float // Total GST amount

  hsnSac        String?
  invoiceNumber String?
  placeOfSupply String
  reverseCharge Boolean @default(false)
}

model Attachment {
  id        String  @id @default(cuid())
  url       String
  voucherId String
  voucher   Voucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)
}

model GSTReturn {
  id         String    @id @default(cuid())
  returnType String // GSTR-1, GSTR-3B
  period     String // e.g., "2024-04"
  status     String // Draft, Filed
  data       String // JSON string storing the return data
  filedDate  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AIInsight {
  id          String  @id @default(cuid())
  type        String // Anomaly, Suggestion
  severity    String // High, Medium, Low
  title       String
  description String
  actionable  Boolean @default(true)

  // Relations
  relatedVouchers Voucher[] @relation("VoucherInsights")

  createdAt DateTime @default(now())
}

model Subscription {
  id        String  @id @default(cuid())
  companyId String  @unique
  company   Company @relation(fields: [companyId], references: [id])

  planId String // SILVER, GOLD, PLATINUM
  status String // ACTIVE, PAST_DUE, CANCELLED

  startDate DateTime @default(now())
  endDate   DateTime

  // Payment Details
  paymentGateway String? // RAZORPAY, OFFLINE
  transactionId  String?
  amountPaid     Float   @default(0)

  // RBAC Features (JSON array of permission strings)
  allowedFeatures String // Stored as JSON string e.g. ["payroll", "inventory"]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// AUDIT TRAIL (MCA MANDATORY REQUIREMENT)
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  entityType  String // "voucher", "account", "user", "company", "inventory", etc.
  entityId    String // ID of the entity being tracked
  action      String // "CREATE", "UPDATE", "DELETE"
  userId      String // User who made the change
  userName    String // Cached username for reporting
  userEmail   String // Cached email
  timestamp   DateTime @default(now())
  ipAddress   String? // IP address of the user
  userAgent   String? // Browser/device info
  oldValue    String? // Previous state (JSON string for SQLite)
  newValue    String? // New state (JSON string for SQLite)
  changes     String? // Specific fields changed with before/after (JSON string)
  description String? // Human-readable description

  @@index([entityType, entityId])
  @@index([userId])
  @@index([timestamp])
  @@index([action])
}

// ============================================
// TDS/TCS (TAX DEDUCTION/COLLECTION AT SOURCE)
// ============================================

model TDSSection {
  id String @id @default(cuid())

  // Multi-Company Scope
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  section        String
  description    String
  thresholdLimit Float // Threshold amount for TDS applicability
  rateWithPAN    Float // TDS rate if PAN is provided
  rateWithoutPAN Float // TDS rate if PAN is not provided
  applicableOn   String // "payment", "credit"
  isActive       Boolean    @default(true)
  entries        TDSEntry[]
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@unique([companyId, section])
}

model TDSEntry {
  id            String     @id @default(cuid())
  voucherId     String
  voucher       Voucher    @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  sectionId     String
  section       TDSSection @relation(fields: [sectionId], references: [id])
  partyId       String
  party         Account    @relation("TDSParty", fields: [partyId], references: [id])
  panNumber     String?
  amount        Float // Taxable amount
  tdsAmount     Float // TDS deducted
  tdsRate       Float // Rate applied
  quarter       String // "Q1-2024", "Q2-2024", etc.
  financialYear String // "2023-24"
  challanNo     String?
  challanDate   DateTime?
  filedDate     DateTime?
  createdAt     DateTime   @default(now())

  @@index([quarter, financialYear])
  @@index([partyId])
  @@index([voucherId])
}

model TCSConfig {
  id String @id @default(cuid())

  // Multi-Company Scope
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  goodsType   String
  description String
  threshold   Float // Threshold amount for TCS applicability
  rate        Float // TCS rate
  isActive    Boolean    @default(true)
  entries     TCSEntry[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([companyId, goodsType])
}

model TCSEntry {
  id            String    @id @default(cuid())
  voucherId     String
  voucher       Voucher   @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  configId      String
  config        TCSConfig @relation(fields: [configId], references: [id])
  partyId       String
  party         Account   @relation("TCSParty", fields: [partyId], references: [id])
  amount        Float // Sale amount
  tcsAmount     Float // TCS collected
  tcsRate       Float // Rate applied
  quarter       String // "Q1-2024", "Q2-2024", etc.
  financialYear String // "2023-24"
  createdAt     DateTime  @default(now())

  @@index([quarter, financialYear])
  @@index([partyId])
  @@index([voucherId])
}

// ============================================
// BANKING MODULE (PHASE 2)
// ============================================

model BankReconciliation {
  id             String       @id @default(cuid())
  voucherEntryId String       @unique // One-to-one with the ledger entry
  voucherEntry   VoucherEntry @relation(fields: [voucherEntryId], references: [id], onDelete: Cascade)

  bankDate       DateTime // Date cleared in bank
  reconciledDate DateTime @default(now()) // When the user reconciled it in system
  status         String   @default("RECONCILED") // RECONCILED (since valid bankDate implies it)

  @@index([bankDate])
}

model ChequeBook {
  id        String  @id @default(cuid())
  accountId String // The Bank Ledger
  account   Account @relation(fields: [accountId], references: [id])

  name           String // e.g. "HDFC Book 1"
  fromNumber     Int // 100001
  toNumber       Int // 100050
  numberOfLeaves Int // 50

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  leaves ChequeLeaf[]
}

model ChequeLeaf {
  id     String     @id @default(cuid())
  bookId String
  book   ChequeBook @relation(fields: [bookId], references: [id], onDelete: Cascade)

  chequeNumber String // "100001" (String to preserve leading zeros if needed)
  status       String @default("AVAILABLE") // AVAILABLE, ISSUED, CANCELLED, BLANK

  // If Issued
  voucherId  String?   @unique
  voucher    Voucher?  @relation(fields: [voucherId], references: [id])
  issuedDate DateTime?
  issuedTo   String? // Party Name

  amount Float?
}

// ============================================

// PHASE 3: INVENTORY & MANUFACTURING MODELS

// ============================================

model StockGroup {
  id String @id @default(cuid())

  // Multi-Company Scope
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name String

  description String?

  // Hierarchy

  parentId String?

  parent StockGroup? @relation("StockGroupHierarchy", fields: [parentId], references: [id])

  children StockGroup[] @relation("StockGroupHierarchy")

  items InventoryItem[]

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  @@unique([companyId, name])
}

model UnitOfMeasure {
  id String @id @default(cuid())

  // Multi-Company Scope
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name String

  symbol String

  decimalPlaces Int @default(2)

  items InventoryItem[]

  createdAt DateTime @default(now())

  @@unique([companyId, name])
}

model BatchTracking {
  id String @id @default(cuid())

  batchNumber String

  itemId String

  item InventoryItem @relation(fields: [itemId], references: [id])

  manufacturingDate DateTime?

  expiryDate DateTime?

  quantity Float

  createdAt DateTime @default(now())

  @@unique([itemId, batchNumber])
}

model SerialNumber {
  id String @id @default(cuid())

  serialNumber String @unique

  itemId String

  item InventoryItem @relation(fields: [itemId], references: [id])

  status String // Available, Sold, Defective

  createdAt DateTime @default(now())
}

model BillOfMaterial {
  id String @id @default(cuid())

  name String

  finishedItemId String

  finishedItem InventoryItem @relation("FinishedItem", fields: [finishedItemId], references: [id])

  components BOMComponent[]

  manufacturingJournals ManufacturingJournal[]

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt
}

model BOMComponent {
  id String @id @default(cuid())

  bomId String

  bom BillOfMaterial @relation(fields: [bomId], references: [id], onDelete: Cascade)

  itemId String

  item InventoryItem @relation("BOMComponentItem", fields: [itemId], references: [id])

  quantity Float

  wastagePercent Float @default(0)
}

model ManufacturingJournal {
  id String @id @default(cuid())

  journalNumber String @unique

  date DateTime

  bomId String

  bom BillOfMaterial @relation(fields: [bomId], references: [id])

  voucherId String

  voucher Voucher @relation(fields: [voucherId], references: [id])

  quantityProduced Float

  totalCost Float

  createdAt DateTime @default(now())
}

// ============================================

// PHASE 4: ADVANCED FEATURES MODELS

// ============================================

model Currency {
  id String @id @default(cuid())

  code String @unique // USD, EUR, GBP

  name String

  symbol String

  exchangeRates ExchangeRate[]

  createdAt DateTime @default(now())
}

model ExchangeRate {
  id String @id @default(cuid())

  currencyId String

  currency Currency @relation(fields: [currencyId], references: [id])

  date DateTime

  rate Float // 1 Foreign Currency = X INR

  createdAt DateTime @default(now())

  @@unique([currencyId, date])
}

model Employee {
  id String @id @default(cuid())

  // Multi-Company Scope
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  employeeCode String

  name String

  email String?

  phone String?

  designation String?

  department String?

  dateOfJoining DateTime
  dateOfLeaving DateTime?

  // Bank Details
  bankName      String?
  accountNumber String?
  ifscCode      String?

  // Statutory Details
  panNumber    String?
  aadharNumber String?
  uanNumber    String?
  esiNumber    String?

  salaryStructureId String?

  salaryStructure SalaryStructure? @relation(fields: [salaryStructureId], references: [id])

  salarySlips   SalarySlip[]
  attendance    AttendanceEntry[]
  salaryDetails EmployeeSalaryDetail[]

  isActive Boolean @default(true)

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  @@unique([companyId, employeeCode])
}

model SalaryStructure {
  id String @id @default(cuid())

  // Multi-Company Scope
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name String

  basicSalary Float

  hra Float @default(0)

  conveyance Float @default(0)

  medicalAllowance Float @default(0)

  otherAllowances Float @default(0)

  pf Float @default(0)

  esi Float @default(0)

  professionalTax Float @default(0)

  employees Employee[]

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  @@unique([companyId, name])
}

model EWayBill {
  id String @id @default(cuid())

  ewayBillNumber String @unique

  voucherId String

  voucher Voucher @relation(fields: [voucherId], references: [id])

  transporterId String?

  vehicleNumber String?

  distance Float?

  generatedDate DateTime

  validUntil DateTime

  status String // Generated, Cancelled

  createdAt DateTime @default(now())
}

// Godown (Warehouse) Models
model Godown {
  id String @id @default(cuid())

  // Multi-Company Scope
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name     String
  location String?

  // Hierarchy Support
  parentId String?
  parent   Godown?  @relation("GodownHierarchy", fields: [parentId], references: [id])
  children Godown[] @relation("GodownHierarchy")

  stockMovements StockMovement[]
  voucherItems   VoucherItem[]
  transfersFrom  StockTransfer[] @relation("FromGodown")
  transfersTo    StockTransfer[] @relation("ToGodown")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, name])
}

model StockTransfer {
  id             String   @id @default(cuid())
  transferNumber String   @unique
  date           DateTime

  fromGodownId String
  fromGodown   Godown @relation("FromGodown", fields: [fromGodownId], references: [id])

  toGodownId String
  toGodown   Godown @relation("ToGodown", fields: [toGodownId], references: [id])

  items  StockTransferItem[]
  status String              @default("PENDING") // PENDING, COMPLETED

  createdBy   String
  createdAt   DateTime  @default(now())
  completedAt DateTime?
}

model StockTransferItem {
  id         String        @id @default(cuid())
  transferId String
  transfer   StockTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)

  itemId String
  item   InventoryItem @relation("TransferItems", fields: [itemId], references: [id])

  quantity    Float
  batchNumber String?
}

// ============================================
// LICENSING & SYSTEM SECURITY
// ============================================

model License {
  id         String @id @default(cuid())
  key        String @unique
  clientName String
  status     String @default("PENDING") // PENDING, ACTIVE, REVOKED
  plan       String @default("PRO") // PRO, ENTERPRISE

  activatedAt DateTime?
  expiresAt   DateTime?

  // Machine ID / Hardlock (Optional future proofing)
  machineId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// MULTI-TENANT SAAS MANAGEMENT
// ============================================

model Tenant {
  id               String    @id @default(cuid())
  name             String
  subdomain        String?   @unique
  subscriptionPlan String
  maxUsers         Int       @default(5)
  enabledModules   String
  status           String    @default("ACTIVE")
  licenseKey       String?   @unique
  expiresAt        DateTime?
  dbInitialized    Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  rbacConfig       RBACConfig?
  provisioningJobs ProvisioningJob[]
}

model RBACConfig {
  id          String   @id @default(cuid())
  tenantId    String   @unique
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  permissions String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ProvisioningJob {
  id             String    @id @default(cuid())
  tenantId       String
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  status         String
  currentStep    String?
  progress       Int       @default(0)
  totalSteps     Int       @default(7)
  completedSteps Int       @default(0)
  steps          String
  error          String?
  createdAt      DateTime  @default(now())
  startedAt      DateTime?
  completedAt    DateTime?
}

// ============================================
// STANDALONE ADMIN CONTROL PANEL
// ============================================

model AdminUser {
  id        String    @id @default(cuid())
  username  String    @unique
  email     String    @unique
  password  String
  role      String    @default("admin")
  isActive  Boolean   @default(true)
  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Client {
  id String @id @default(cuid())

  companyName    String
  tradeName      String?
  registrationNo String?

  pan   String?
  gstin String?
  tan   String?
  cin   String?

  email          String
  phone          String
  alternatePhone String?
  website        String?

  address String
  city    String
  state   String
  pincode String
  country String @default("India")

  businessType   String
  industryType   String?
  annualTurnover Float?

  subscriptionPlan  String
  subscriptionStart DateTime
  subscriptionEnd   DateTime?
  maxUsers          Int       @default(5)
  enabledModules    String

  licenseKey    String? @unique
  licenseStatus String  @default("ACTIVE")

  kycStatus     String    @default("PENDING")
  kycDocuments  String?
  kycVerifiedAt DateTime?
  kycVerifiedBy String?

  billingEmail   String?
  billingAddress String?
  gstTreatment   String?

  status    String   @default("ACTIVE")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users ClientUser[]
}

model ClientUser {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  name         String
  email        String @unique
  role         String @default("user")
  moduleAccess String

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, email])
  @@index([clientId])
}

// ============================================
// PHASE 1: ORDER MANAGEMENT MODELS
// ============================================

model Quote {
  id          String    @id @default(cuid())
  quoteNumber String    @unique
  date        DateTime
  expiryDate  DateTime?

  // Party (Prospective or Existing Customer)
  partyId   String
  party     Account @relation(fields: [partyId], references: [id])
  partyName String? // For prosepects not yet in Account master? No, let's enforce Account.

  status String @default("DRAFT") // DRAFT, SENT, ACCEPTED, DECLINED, CONVERTED

  totalAmount  Float
  currency     String @default("INR")
  exchangeRate Float  @default(1.0)

  // Items
  items QuoteItem[]

  // Conversion Links
  convertedToOrder SalesOrder? @relation("QuoteToOrder")

  convertedToInvoice Voucher? @relation("QuoteToInvoice")

  termsAndConditions String?
  notes              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model QuoteItem {
  id      String @id @default(cuid())
  quoteId String
  quote   Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  // Item Details
  itemId String?
  item   InventoryItem? @relation(fields: [itemId], references: [id])

  description String?

  quantity Float
  rate     Float
  discount Float @default(0)

  taxableAmount Float
  taxAmount     Float
  totalAmount   Float

  hsnSac  String?
  gstRate Float   @default(0)
}

model SalesOrder {
  id           String    @id @default(cuid())
  orderNumber  String    @unique
  date         DateTime
  deliveryDate DateTime?

  partyId String
  party   Account @relation(fields: [partyId], references: [id])

  status String @default("OPEN") // OPEN, PARTIALLY_PARTIALLY_INVOICED, INVOICED, CANCELLED, CLOSED

  totalAmount Float

  items SalesOrderItem[]

  // Links
  originalQuoteId String? @unique
  originalQuote   Quote?  @relation("QuoteToOrder", fields: [originalQuoteId], references: [id])

  invoices SalesOrderInvoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SalesOrderItem {
  id           String     @id @default(cuid())
  salesOrderId String
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)

  itemId String?
  item   InventoryItem? @relation(fields: [itemId], references: [id])

  description String?

  quantity          Float
  invoicedQuantity  Float @default(0) // Track how much has been converted to invoice
  cancelledQuantity Float @default(0)

  rate     Float
  discount Float @default(0)

  taxableAmount Float
  taxAmount     Float
  totalAmount   Float

  hsnSac  String?
  gstRate Float   @default(0)
}

// Join table for SO -> Invoice (One Invoice can contain items from multiple SOs, or One SO can be split into multiple Invoices)
// For simplicity, let's just do One SO can have multiple Invoices, but usually Invoices link back to SO.
// We'll add a link in Voucher (Invoice) to SO, or use a join table.
// Let's use a join table to map valid relations.
model SalesOrderInvoice {
  id String @id @default(cuid())

  salesOrderId String
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id])

  invoiceId String
  invoice   Voucher @relation(fields: [invoiceId], references: [id])

  createdAt DateTime @default(now())

  @@unique([salesOrderId, invoiceId])
}

model PurchaseOrder {
  id           String    @id @default(cuid())
  orderNumber  String    @unique
  date         DateTime
  expectedDate DateTime?

  partyId String
  party   Account @relation(fields: [partyId], references: [id]) // Vendor

  status String @default("OPEN") // OPEN, GRN_PENDING, BILLED, CLOSED, CANCELLED

  totalAmount Float

  items PurchaseOrderItem[]

  // Links
  bills PurchaseOrderBill[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  itemId String?
  item   InventoryItem? @relation(fields: [itemId], references: [id])

  description String?

  quantity         Float
  receivedQuantity Float @default(0) // From GRN (Goods Receipt Note) - Future Phase
  billedQuantity   Float @default(0) // From Purchase Voucher

  rate Float

  taxableAmount Float
  taxAmount     Float
  totalAmount   Float

  hsnSac  String?
  gstRate Float   @default(0)
}

model PurchaseOrderBill {
  id String @id @default(cuid())

  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])

  billId String
  bill   Voucher @relation(fields: [billId], references: [id])

  createdAt DateTime @default(now())

  @@unique([purchaseOrderId, billId])
}

// ============================================
// PHASE 2: PROJECT MANAGEMENT MODELS
// ============================================

model Project {
  id String @id @default(cuid())

  // Multi-Company Scope
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name        String
  description String?

  customerId String // Link to Account (Debtor)
  customer   Account @relation(fields: [customerId], references: [id])

  billingType String @default("HOURLY") // HOURLY, FIXED_COST, NON_BILLABLE

  // For Fixed Cost
  projectAmount Float @default(0)

  // For Hourly
  ratePerHour Float @default(0) // Default rate, can be overridden by task/user

  status String @default("ACTIVE") // ACTIVE, COMPLETED, ARCHIVED, ON_HOLD

  startDate DateTime  @default(now())
  endDate   DateTime?

  tasks      ProjectTask[]
  timesheets Timesheet[]
  expenses   ProjectExpense[]

  invoices ProjectInvoice[] // Link to generated invoices

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProjectTask {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name        String
  description String?

  isBillable  Boolean @default(true)
  ratePerHour Float? // Override project rate

  timesheetEntries TimesheetEntry[]

  createdAt DateTime @default(now())
}

model Timesheet {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  date DateTime

  entries TimesheetEntry[]

  status String @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, REJECTED

  approvedBy String?
  approvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TimesheetEntry {
  id          String    @id @default(cuid())
  timesheetId String
  timesheet   Timesheet @relation(fields: [timesheetId], references: [id], onDelete: Cascade)

  taskId String
  task   ProjectTask @relation(fields: [taskId], references: [id])

  hours       Float
  description String?

  isBillable Boolean @default(true)

  // Billing Status
  billingStatus String   @default("UNBILLED") // UNBILLED, BILLED, IGNORED
  invoiceId     String?
  invoice       Voucher? @relation(fields: [invoiceId], references: [id])
}

model ProjectExpense {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  date   DateTime
  amount Float

  description String?

  isBillable Boolean @default(true)
  markup     Float   @default(0) // e.g. 10% markup

  // Link to Purchase Voucher (Expense Claim)
  voucherEntryId String?
  voucherEntry   VoucherEntry? @relation(fields: [voucherEntryId], references: [id])

  billingStatus String   @default("UNBILLED")
  invoiceId     String?
  invoice       Voucher? @relation(fields: [invoiceId], references: [id])

  createdAt     DateTime     @default(now())
  VoucherType   VoucherType? @relation(fields: [voucherTypeId], references: [id])
  voucherTypeId String?
}

// Join table for Project -> Invoices
model ProjectInvoice {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  invoiceId String
  invoice   Voucher @relation(fields: [invoiceId], references: [id])

  createdAt DateTime @default(now())

  @@unique([projectId, invoiceId])
}

// ============================================
// PHASE 3: ADVANCED ACCOUNTING MODELS
// ============================================

model Budget {
  id String @id @default(cuid())

  // Multi-Company Scope
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name String // e.g. "FY 2024-25 Budget"

  financialYearStart DateTime
  financialYearEnd   DateTime

  period String @default("MONTHLY") // MONTHLY, QUARTERLY, YEARLY

  entries BudgetEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BudgetEntry {
  id       String @id @default(cuid())
  budgetId String
  budget   Budget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  // Period details (e.g. Month 1, 2... or Quarter 1)
  periodIndex Int // 1-12 for Monthly, 1-4 for Quarterly
  amount      Float

  @@unique([budgetId, accountId, periodIndex])
}

model FixedAsset {
  id String @id @default(cuid())

  // Multi-Company Scope
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name        String
  assetNumber String?
  description String?

  // Links
  accountId String // The Fixed Asset Ledger (e.g., Computers)
  account   Account @relation("AssetAccount", fields: [accountId], references: [id])

  // Depreciation Configuration
  depreciationMethod String @default("STRAIGHT_LINE") // STRAIGHT_LINE, DECLINING_BALANCE
  depreciationRate   Float  @default(0) // Percentage per year
  usefulLifeInYears  Float?

  // Accounts for Posting Depreciation
  depreciationExpenseAccountId String?
  depreciationExpenseAccount   Account? @relation("DepreciationExpense", fields: [depreciationExpenseAccountId], references: [id])

  accumulatedDepreciationAccountId String?
  accumulatedDepreciationAccount   Account? @relation("AccumulatedDepreciation", fields: [accumulatedDepreciationAccountId], references: [id])

  // Purchase Details
  purchaseDate DateTime
  purchaseCost Float
  salvageValue Float    @default(0)

  // Status
  status String @default("ACTIVE") // ACTIVE, SOLD, WRITTEN_OFF

  // Depreciation History
  depreciationEntries DepreciationEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, assetNumber])
}

model DepreciationEntry {
  id      String     @id @default(cuid())
  assetId String
  asset   FixedAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  postedDate DateTime
  amount     Float

  // Link to the Journal Voucher created
  voucherId String?
  voucher   Voucher? @relation(fields: [voucherId], references: [id])

  createdAt DateTime @default(now())
}

// ============================================
// PHASE 4: PORTAL MODELS
// ============================================

model PortalUser {
  id       String  @id @default(cuid())
  email    String  @unique
  password String // Hashed
  name     String?

  // Link to Account (Party - Debtor or Creditor)
  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  role String @default("VIEWER") // VIEWER, EDITOR

  lastLogin DateTime?
  isActive  Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
