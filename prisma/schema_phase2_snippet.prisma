
// ============================================
// PHASE 2: PROJECT MANAGEMENT MODELS
// ============================================

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  
  customerId  String  // Link to Account (Debtor)
  customer    Account @relation(fields: [customerId], references: [id])
  
  billingType String @default("HOURLY") // HOURLY, FIXED_COST, NON_BILLABLE
  
  // For Fixed Cost
  projectAmount Float @default(0)
  
  // For Hourly
  ratePerHour Float @default(0) // Default rate, can be overridden by task/user
  
  status      String @default("ACTIVE") // ACTIVE, COMPLETED, ARCHIVED, ON_HOLD
  
  startDate   DateTime @default(now())
  endDate     DateTime?
  
  tasks       ProjectTask[]
  timesheets  Timesheet[]
  expenses    ProjectExpense[]
  
  invoices    ProjectInvoice[] // Link to generated invoices
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ProjectTask {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  
  isBillable  Boolean @default(true)
  ratePerHour Float? // Override project rate
  
  timesheetEntries TimesheetEntry[]
  
  createdAt   DateTime @default(now())
}

model Timesheet {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  
  userId      String   
  user        User     @relation(fields: [userId], references: [id])
  
  date        DateTime
  
  entries     TimesheetEntry[]
  
  status      String @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, REJECTED
  
  approvedBy  String?
  approvedAt  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TimesheetEntry {
  id          String   @id @default(cuid())
  timesheetId String
  timesheet   Timesheet @relation(fields: [timesheetId], references: [id], onDelete: Cascade)
  
  taskId      String
  task        ProjectTask @relation(fields: [taskId], references: [id])
  
  hours       Float
  description String?
  
  isBillable  Boolean @default(true)
  
  // Billing Status
  billingStatus String @default("UNBILLED") // UNBILLED, BILLED, IGNORED
  invoiceId     String?
  invoice       Voucher? @relation(fields: [invoiceId], references: [id])
}

model ProjectExpense {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])

  date      DateTime
  amount    Float
  
  description String?
  
  isBillable Boolean @default(true)
  markup     Float   @default(0) // e.g. 10% markup
  
  // Link to Purchase Voucher (Expense Claim)
  voucherEntryId String?
  voucherEntry   VoucherEntry? @relation(fields: [voucherEntryId], references: [id])
  
  billingStatus String @default("UNBILLED")
  invoiceId     String?
  invoice       Voucher? @relation(fields: [invoiceId], references: [id])
  
  createdAt DateTime @default(now())
}

// Join table for Project -> Invoices
model ProjectInvoice {
  id String @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id])
  
  invoiceId String
  invoice   Voucher @relation(fields: [invoiceId], references: [id])
  
  createdAt DateTime @default(now())
  
  @@unique([projectId, invoiceId])
}
