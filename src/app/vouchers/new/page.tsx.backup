'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { Save, ArrowLeft, Plus, Trash2, FileText } from 'lucide-react';
import Link from 'next/link';
import { cn } from '@/lib/utils';

// import Tesseract from 'tesseract.js'; // Moved to Server API
// import { parseInvoiceText } from '@/lib/invoice-parser'; // Moved to Server API

// Helper for rounding to 2 decimal places
const round = (num: number) => Math.round((num + Number.EPSILON) * 100) / 100;

interface VoucherItem {
    id: string; // temp id
    productName: string;
    description: string;
    hsnSac: string;
    qty: number;
    rate: number;
    per: string;
    inventoryItemId?: string | null;
    godownId?: string | null; // Godown Selection

    // Taxes (Inputs)
    cgstRate: number;
    sgstRate: number;
    igstRate: number;

    // Computed (Read-only for user, calculated by effect)
    taxableAmount: number;
    cgstAmount: number;
    sgstAmount: number;
    igstAmount: number;
    totalAmount: number;
}

const EMPTY_ITEM: VoucherItem = {
    id: '',
    productName: '',
    description: '',
    hsnSac: '',
    qty: 0,
    rate: 0,
    per: 'pcs',
    cgstRate: 0,
    sgstRate: 0,
    igstRate: 0,
    taxableAmount: 0,
    cgstAmount: 0,
    sgstAmount: 0,
    igstAmount: 0,
    totalAmount: 0
};

export default function NewVoucherPage() {
    const router = useRouter();
    const [loading, setLoading] = useState(false);
    const [accounts, setAccounts] = useState<any[]>([]);
    const [mode, setMode] = useState<'ITEM' | 'ACCOUNTING'>('ITEM');
    const [templates, setTemplates] = useState<any[]>([]);

    useEffect(() => {
        // Fetch Templates
        fetch('/api/vouchers?isRecurring=true').then(r => r.json()).then(data => {
            if (Array.isArray(data)) setTemplates(data);
        });
    }, []);

    // Items State
    const [items, setItems] = useState<VoucherItem[]>([
        { ...EMPTY_ITEM, id: Math.random().toString(36).substr(2, 9) }
    ]);

    // AI Scanner State
    const [isScanning, setIsScanning] = useState(false);
    const [scanProgress, setScanProgress] = useState(0);
    const [scannedImage, setScannedImage] = useState<string | null>(null);
    const [showReview, setShowReview] = useState(false);
    const [rawText, setRawText] = useState<string>(''); // For Debugging
    const [confidence, setConfidence] = useState<number>(0);

    // Helper to format extracted date
    const formatDateForInput = (dateStr: string) => {
        try {
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
            const parts = dateStr.match(/\d+/g);
            if (parts && parts.length === 3) {
                if (parts[0].length === 4) return `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
        } catch (e) { return dateStr; }
        return dateStr;
    };

    const handleMagicImport = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file) return;

        setIsScanning(true);
        setScanProgress(10); // Start at 10%
        const imageUrl = URL.createObjectURL(file);
        setScannedImage(imageUrl);
        setShowReview(true);
        setRawText('Uploading and Scanning on Server...');
        setConfidence(0);

        const formData = new FormData();
        formData.append('file', file);

        // Simulate progress
        const progressInterval = setInterval(() => {
            setScanProgress(prev => {
                if (prev >= 90) return prev; // Stop at 90% until API responds
                return prev + 10;
            });
        }, 500);

        try {
            const res = await fetch('/api/ai/scan-voucher', {
                method: 'POST',
                body: formData
            });

            clearInterval(progressInterval);

            if (!res.ok) {
                const errorText = await res.text();
                console.error('Scan API Error:', errorText);
                throw new Error(`Scan failed: ${res.status} - ${errorText}`);
            }

            const result = await res.json();
            const { text, extracted } = result;

            console.log('OCR Result:', text);
            setRawText(text || 'No text extracted');
            setScanProgress(100);

            // Set a dummy confidence since server-side simple tesseract call doesn't return it easily in this structure
            // or we could update the API to return it. For now, assume 85%.
            setConfidence(85);

            setFormData(prev => ({
                ...prev,
                type: 'PURCHASE', // Default to Purchase
                date: extracted.date ? formatDateForInput(extracted.date) : prev.date,
                invoiceNumber: extracted.invoiceNumber || prev.invoiceNumber,
                narration: extracted.invoiceNumber
                    ? `Imported from Invoice #${extracted.invoiceNumber}.`
                    : prev.narration
            }));

            // Auto-Add Item if Amount found
            if (extracted.amount && (items.length <= 1 && !items[0].productName)) {
                setItems([{
                    ...EMPTY_ITEM,
                    id: Math.random().toString(36).substr(2, 9),
                    productName: 'Imported Service/Item',
                    description: 'Auto-detected from invoice',
                    rate: extracted.amount,
                    taxableAmount: extracted.amount,
                    totalAmount: extracted.amount,
                    qty: 1
                }]);
            }
        } catch (error) {
            clearInterval(progressInterval);
            console.error('OCR Failed', error);
            const errorMessage = error instanceof Error ? error.message : 'Unknown error';
            alert(`Failed to scan invoice: ${errorMessage}`);
            setRawText(`Error: ${errorMessage}\n\nPlease check:\n1. The API endpoint /api/ai/scan-voucher exists\n2. Tesseract.js is properly installed\n3. The image is readable`);
            setScanProgress(0);
        } finally {
            clearInterval(progressInterval);
            setIsScanning(false);
        }
    };

    // State for Form Data
    const [formData, setFormData] = useState({
        date: new Date().toISOString().split('T')[0],
        number: '',
        type: 'PAYMENT', // Removed strict type to allow AI update
        amount: 0,
        currency: 'INR',
        exchangeRate: 1.0,
        costCenterId: '',
        narration: '',
        accountId: '',
        accountName: '',
        invoiceNumber: '',
        // TDS/TCS fields
        tdsApplicable: false,
        tdsSectionId: '',
        tdsAmount: 0,
        partyPAN: '',
        tcsApplicable: false,
        tcsConfigId: '',
        tcsConfigId: '',
        tcsAmount: 0,
        // Cost Allocation
        tcsAmount: 0,
        // Cost Allocation
        allocations: [] as { costCenterId: string, amount: number }[],
        // Post-Dated Cheque
        isPostDated: false,
        pdcDate: '', // Only used if isPostDated is true
        isOptional: false // Memo Voucher
    });

    // Cost Allocation State
    const [showCostCenterModal, setShowCostCenterModal] = useState(false);
    const [tempAllocations, setTempAllocations] = useState<{ costCenterId: string, amount: number }[]>([{ costCenterId: '', amount: 0 }]);

    // Generate voucher number
    useEffect(() => {
        const fetchNextVoucherNumber = async () => {
            try {
                const res = await fetch('/api/vouchers/next-number');
                if (res.ok) {
                    const data = await res.json();
                    setFormData(prev => ({ ...prev, number: data.voucherNumber }));
                } else {
                    const now = new Date();
                    const day = String(now.getDate()).padStart(2, '0');
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const year = String(now.getFullYear()).slice(-2);
                    setFormData(prev => ({ ...prev, number: `VCH-${day}${month}${year}000001` }));
                }
            } catch (error) {
                console.error('Failed to fetch voucher number:', error);
            }
        };
        fetchNextVoucherNumber();
    }, []);

    // Fetch Accounts, Cost Centers, and Godowns
    const [costCenters, setCostCenters] = useState<any[]>([]);
    const [godowns, setGodowns] = useState<any[]>([]);
    const [tdsSections, setTdsSections] = useState<any[]>([]);
    const [tcsConfigs, setTcsConfigs] = useState<any[]>([]);

    useEffect(() => {
        const fetchMasters = async () => {
            try {
                const [accountsRes, costCentersRes, godownsRes, tdsSectionsRes, tcsConfigsRes] = await Promise.all([
                    fetch('/api/accounts'),
                    fetch('/api/cost-centers'),
                    fetch('/api/godowns'),
                    fetch('/api/tds/sections'),
                    fetch('/api/tcs/configs')
                ]);

                if (accountsRes.ok) {
                    setAccounts(await accountsRes.json());
                }
                if (costCentersRes.ok) {
                    setCostCenters(await costCentersRes.json());
                }
                if (godownsRes.ok) {
                    setGodowns(await godownsRes.json());
                }
                if (tdsSectionsRes.ok) {
                    setTdsSections(await tdsSectionsRes.json());
                }
                if (tcsConfigsRes.ok) {
                    setTcsConfigs(await tcsConfigsRes.json());
                }
            } catch (error) {
                console.error('Failed to fetch masters', error);
            }
        };
        fetchMasters();
    }, []);

    // Auto-calculate TDS
    useEffect(() => {
        if (formData.tdsApplicable && formData.tdsSectionId && formData.amount > 0) {
            const section = tdsSections.find((s: any) => s.id === formData.tdsSectionId);
            if (section) {
                const hasPAN = formData.partyPAN && formData.partyPAN.length === 10;
                const rate = hasPAN ? section.rateWithPAN : section.rateWithoutPAN;
                const tdsAmount = (formData.amount * rate) / 100;
                setFormData(prev => ({ ...prev, tdsAmount: parseFloat(tdsAmount.toFixed(2)) }));
            }
        } else {
            setFormData(prev => ({ ...prev, tdsAmount: 0 }));
        }
    }, [formData.tdsApplicable, formData.tdsSectionId, formData.amount, formData.partyPAN, tdsSections]);

    // Auto-calculate TCS
    useEffect(() => {
        if (formData.tcsApplicable && formData.tcsConfigId && formData.amount > 0) {
            const config = tcsConfigs.find((c: any) => c.id === formData.tcsConfigId);
            if (config) {
                const tcsAmount = (formData.amount * config.rate) / 100;
                setFormData(prev => ({ ...prev, tcsAmount: parseFloat(tcsAmount.toFixed(2)) }));
            }
        } else {
            setFormData(prev => ({ ...prev, tcsAmount: 0 }));
        }
    }, [formData.tcsApplicable, formData.tcsConfigId, formData.amount, tcsConfigs]);

    // Inventory Master State
    const [inventoryMaster, setInventoryMaster] = useState<any[]>([]);

    useEffect(() => {
        // Fetch Inventory Master
        fetch('/api/inventory/items').then(res => res.json()).then(data => {
            if (Array.isArray(data)) setInventoryMaster(data);
        }).catch(err => console.error(err));
    }, []);


    // ^ This dependency array is tricky. If we update items inside, it loops. 
    // BETTER APPROACH: Calculate in the Change Handler.

    // Calculate Grand Total Update Logic (useEffect replacement)
    useEffect(() => {
        const grandTotal = items.reduce((sum, item) => sum + item.totalAmount, 0);
        if (Math.abs(formData.amount - grandTotal) > 0.01) {
            setFormData(prev => ({ ...prev, amount: grandTotal }));
        }
    }, [items]); // Only update when items change (and totalAmount inside them changes)

    const handleItemChange = (id: string, field: keyof VoucherItem, value: any) => {
        setItems(prevItems => prevItems.map(item => {
            if (item.id !== id) return item;

            const newItem = { ...item, [field]: value };

            // Logic: If Product Name changes, try to find in Master
            if (field === 'productName') {
                const masterItem = inventoryMaster.find(i => i.name === value);
                if (masterItem) {
                    newItem.inventoryItemId = masterItem.id;
                    newItem.hsnSac = masterItem.hsnCode || newItem.hsnSac;
                    newItem.per = masterItem.unit || newItem.per;

                    if (formData.type === 'PURCHASE') {
                        newItem.rate = masterItem.purchaseRate || newItem.rate;
                    } else if (formData.type === 'SALES') {
                        newItem.rate = masterItem.saleRate || newItem.rate;
                    }
                }
            }

            // Auto-calculate on change
            if (['qty', 'rate', 'cgstRate', 'sgstRate', 'igstRate', 'productName'].includes(field as string)) {
                newItem.taxableAmount = round(newItem.qty * newItem.rate);
                newItem.cgstAmount = round(newItem.taxableAmount * (newItem.cgstRate / 100));
                newItem.sgstAmount = round(newItem.taxableAmount * (newItem.sgstRate / 100));
                newItem.igstAmount = round(newItem.taxableAmount * (newItem.igstRate / 100));
                newItem.totalAmount = round(newItem.taxableAmount + newItem.cgstAmount + newItem.sgstAmount + newItem.igstAmount);
            }
            return newItem;
        }));
    };

    // Calculate Grand Total for Display
    const grandTotal = items.reduce((sum, item) => sum + item.totalAmount, 0);

    const addItem = () => {
        setItems([...items, { ...EMPTY_ITEM, id: Math.random().toString(36).substr(2, 9) }]);
    };

    const removeItem = (id: string) => {
        if (items.length === 1) return; // Prevent deleting last row
        setItems(items.filter(i => i.id !== id));
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);

        // Ensure we send the calculated amount
        const payload = {
            ...formData,
            amount: grandTotal,
            items: items.map(({ id, ...rest }) => rest) // Remove temp ID
        };

        try {
            const res = await fetch('/api/vouchers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error('Failed to save voucher');

            router.push('/vouchers');
        } catch (error) {
            console.error(error);
            alert('Failed to save voucher');
        } finally {
            setLoading(false);
        }
    };

    // --- Cost Allocation Helpers ---
    const handleCostCenterClick = () => {
        // Find if current account needs it
        const acc = accounts.find(a => a.id === formData.accountId);
        if (acc && acc.isCostCenterEnabled) {
            // Load existing or init
            if (formData.allocations.length > 0) {
                setTempAllocations(formData.allocations);
            } else {
                setTempAllocations([{ costCenterId: '', amount: formData.amount }]);
            }
            setShowCostCenterModal(true);
        } else {
            alert('Cost Centers are not enabled for this ledger. Enable it in Master > Ledger > Alter.');
        }
    };

    const saveAllocations = () => {
        const totalAllocated = tempAllocations.reduce((sum, a) => sum + (parseFloat(a.amount as any) || 0), 0);
        if (Math.abs(totalAllocated - formData.amount) > 0.01) {
            alert(`Total allocated (${totalAllocated}) must match Entry Amount (${formData.amount})`);
            return;
        }
        setFormData(prev => ({ ...prev, allocations: tempAllocations }));
        setShowCostCenterModal(false);
    };

    const addAllocationRow = () => {
        setTempAllocations([...tempAllocations, { costCenterId: '', amount: 0 }]);
    };

    const removeAllocationRow = (index: number) => {
        if (tempAllocations.length === 1) return;
        setTempAllocations(tempAllocations.filter((_, i) => i !== index));
    };

    const updateAllocation = (index: number, field: string, value: any) => {
        const newAlloc = [...tempAllocations];
        newAlloc[index] = { ...newAlloc[index], [field]: value };
        setTempAllocations(newAlloc);
    };

    return (
        <div className="min-h-screen bg-lekhya-base flex flex-col font-sans">
            {/* Header */}
            <header className="bg-lekhya-primary text-white h-12 flex items-center justify-between px-4 border-b-[3px] border-lekhya-accent shadow-sm sticky top-0 z-10">
                <div className="flex items-center gap-4">
                    <Link href="/vouchers" className="hover:bg-white/10 p-1.5 rounded-full transition-colors" title="Back to Vouchers (Esc)">
                        <ArrowLeft className="w-5 h-5 text-lekhya-accent" />
                    </Link>
                    <div className="flex flex-col">
                        <h1 className="text-lg font-bold tracking-wide leading-tight">Item Invoice Entry</h1>
                        <div className="flex items-center gap-2 text-xs font-normal text-blue-200">
                            <span>Load Template:</span>
                            <select
                                className="bg-white/10 border border-white/20 rounded px-1 py-0.5 text-white w-32 focus:w-48 transition-all outline-none"
                                onChange={(e) => {
                                    const tmpl = templates.find(t => t.id === e.target.value);
                                    if (tmpl) {
                                        setFormData({
                                            ...formData,
                                            type: tmpl.voucherType,
                                            // Simple mapping
                                            narration: tmpl.narration,
                                            isRecurring: false, // Don't make the new one recurring by default
                                            items: (tmpl.items || []).map((i: any) => ({
                                                ...i,
                                                id: Math.random().toString(36),
                                            }))
                                        });
                                        if (tmpl.items && tmpl.items.length > 0) {
                                            setItems((tmpl.items || []).map((i: any) => ({
                                                ...i,
                                                id: Math.random().toString(36),
                                            })));
                                        }
                                        alert('Template Loaded');
                                    }
                                }}
                            >
                                <option value="">-- Select --</option>
                                {templates.map(t => (
                                    <option key={t.id} value={t.id}>{t.voucherNumber} ({t.voucherType})</option>
                                ))}
                            </select>
                        </div>
                    </div>
                </div>
                <div className="text-xs text-white/50 font-mono">
                    {formData.number}
                </div>
            </header>

            <div className="flex flex-1 overflow-hidden">
                {/* Left Panel: Review Mode */}
                {showReview && scannedImage && (
                    <div className="w-1/2 bg-slate-800 p-4 border-r border-slate-700 flex flex-col gap-4 relative overflow-hidden">
                        <div className="flex justify-between items-center text-white shrink-0">
                            <h3 className="font-bold flex items-center gap-2">
                                <FileText className="w-4 h-4 text-lekhya-accent" /> Scanned Invoice
                            </h3>
                            <div className="flex items-center gap-3">
                                {!isScanning && confidence > 0 && (
                                    <span className={cn(
                                        "text-xs font-bold px-2 py-0.5 rounded-full border",
                                        confidence > 80 ? "bg-green-500/20 text-green-400 border-green-500/50" :
                                            confidence > 50 ? "bg-yellow-500/20 text-yellow-400 border-yellow-500/50" :
                                                "bg-red-500/20 text-red-400 border-red-500/50"
                                    )}>
                                        Accuracy: {confidence}%
                                    </span>
                                )}
                                <button onClick={() => setShowReview(false)} className="text-sm text-slate-400 hover:text-white">Close Preview</button>
                            </div>
                        </div>

                        {isScanning && (
                            <div className="absolute inset-0 bg-black/50 flex flex-col items-center justify-center z-10 backdrop-blur-sm">
                                <div className="w-64 bg-slate-700 rounded-full h-2 mb-2">
                                    <div className="bg-lekhya-accent h-2 rounded-full transition-all duration-300" style={{ width: `${scanProgress}%` }}></div>
                                </div>
                                <span className="text-white font-bold animate-pulse">Scanning Intelligence... {scanProgress}%</span>
                            </div>
                        )}

                        <div className="flex-1 overflow-auto bg-black rounded border border-slate-600 flex items-center justify-center p-2 relative group">
                            <img src={scannedImage} alt="Scanned Invoice" className="max-w-full h-auto shadow-lg" />
                            {/* Debug Text Overlay on Hover */}
                            <div className="absolute inset-0 bg-black/80 text-green-400 font-mono text-xs p-4 overflow-auto opacity-0 group-hover:opacity-100 transition-opacity whitespace-pre-wrap">
                                <strong>RAW DATA DEBUG:</strong>
                                <br />
                                {rawText}
                            </div>
                        </div>
                        <div className="text-xs text-slate-500 text-center"> Hover image to see raw OCR data</div>
                    </div>
                )}

                {/* Right Panel: Form */}
                <div className={cn("flex-1 overflow-auto p-4 md:p-8 transition-all duration-300", showReview ? "w-1/2 bg-slate-100" : "w-full max-w-[1400px] mx-auto")}>

                    {/* Magic Import Banner */}
                    {!showReview && (
                        <div className="mb-6 bg-gradient-to-r from-indigo-900 to-lekhya-primary p-6 rounded-lg shadow-lg text-white flex items-center justify-between border border-white/10">
                            <div>
                                <h2 className="text-xl font-bold flex items-center gap-2">
                                    <span className="text-2xl">✨</span> Magic Import
                                </h2>
                                <p className="text-indigo-200 text-sm mt-1">
                                    Drop an invoice image here to auto-fill this form using AI.
                                </p>
                            </div>
                            <label className="cursor-pointer bg-white text-lekhya-primary px-6 py-2.5 rounded-sm font-bold hover:bg-indigo-50 transition-transform hover:scale-105 active:scale-95 flex items-center gap-2 shadow-md">
                                <span>Upload Invoice</span>
                                <input type="file" accept="image/*" onChange={handleMagicImport} className="hidden" />
                            </label>
                        </div>
                    )}

                    <form onSubmit={handleSubmit} className="bg-white rounded-sm shadow-sm border border-[#BDCDD6] overflow-hidden">
                        {/* Header Details */}
                        <div className="bg-[#F8FAFC] px-8 py-4 border-b border-[#E2E8F0] flex justify-between items-center">
                            <h2 className="text-lekhya-primary font-bold text-sm uppercase tracking-wide">Invoice Details</h2>
                            <div className="text-xs font-bold text-slate-500">No. {formData.number}</div>
                        </div>

                        <div className="p-6 space-y-6">
                            {/* Top Section: Party & Invoice Info */}
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div>
                                    <label className="block text-xs font-bold text-lekhya-primary uppercase mb-1">Voucher Type</label>
                                    <select
                                        className="lekhya-input"
                                        value={formData.type}
                                        onChange={(e) => setFormData({ ...formData, type: e.target.value as any })}
                                    >
                                        <option value="PAYMENT">Payment</option>
                                        <option value="RECEIPT">Receipt</option>
                                        <option value="SALES">Sales</option>
                                        <option value="PURCHASE">Purchase</option>
                                        <option value="JOURNAL">Journal</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-lekhya-primary uppercase mb-1">Date</label>
                                    <input
                                        type="date"
                                        className="lekhya-input"
                                        value={formData.date}
                                        onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-lekhya-primary uppercase mb-1">
                                        {formData.type === 'PAYMENT' ? 'Account (Dr)' : 'Party A/c Name'}
                                    </label>
                                    <select
                                        className="lekhya-input bg-yellow-50/50"
                                        value={formData.accountId}
                                        onChange={(e) => {
                                            const selected = accounts.find(a => a.id === e.target.value);
                                            setFormData({
                                                ...formData,
                                                accountId: e.target.value,
                                                accountName: selected ? selected.name : ''
                                            });
                                        }}
                                        required
                                    >
                                        <option value="" disabled>Select Ledger...</option>
                                        {accounts.map(acc => (
                                            <option key={acc.id} value={acc.id}>{acc.name}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            {/* Invoice Number */}
                            <div className="max-w-md">
                                <label className="block text-xs font-bold text-lekhya-primary uppercase mb-1">
                                    Vendor Invoice Number (Optional)
                                </label>
                                <input
                                    type="text"
                                    className="lekhya-input"
                                    placeholder="Ref No."
                                    value={formData.invoiceNumber}
                                    onChange={(e) => setFormData({ ...formData, invoiceNumber: e.target.value })}
                                />
                            </div>

                        </div>

                        {/* PDC Section (Only for Payment/Receipt/Contra) */}
                        {['PAYMENT', 'RECEIPT', 'CONTRA'].includes(formData.type) && (
                            <div className="col-span-1 lg:col-span-3 bg-blue-50 p-4 rounded-lg flex items-center gap-6 border border-blue-100">
                                <div className="flex items-center gap-3">
                                    <input
                                        type="checkbox"
                                        id="isPostDated"
                                        className="w-5 h-5 text-lekhya-accent focus:ring-lekhya-accent"
                                        checked={formData.isPostDated}
                                        onChange={(e) => setFormData({ ...formData, isPostDated: e.target.checked })}
                                    />
                                    <label htmlFor="isPostDated" className="font-bold text-sm text-lekhya-primary select-none cursor-pointer">
                                        Mark as Post-Dated Cheque (PDC)?
                                    </label>
                                </div>

                                {formData.isPostDated && (
                                    <div className="flex items-center gap-3 animate-in fade-in slide-in-from-left-4">
                                        <label className="text-xs font-bold uppercase text-slate-600">PDC Date:</label>
                                        <input
                                            type="date"
                                            className="lekhya-input w-40"
                                            value={formData.pdcDate}
                                            onChange={(e) => setFormData({ ...formData, pdcDate: e.target.value })}
                                            required={formData.isPostDated}
                                        />
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Multi-Currency Section */}
                        {/* Enterprise Features: Multi-Currency & Cost Centers */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div>
                                <label className="block text-xs font-bold text-lekhya-primary uppercase mb-1">Currency</label>
                                <select
                                    className="lekhya-input"
                                    value={formData.currency}
                                    onChange={(e) => setFormData({ ...formData, currency: e.target.value, exchangeRate: e.target.value === 'INR' ? 1.0 : formData.exchangeRate })}
                                >
                                    <option value="INR">INR (₹)</option>
                                    <option value="USD">USD ($)</option>
                                    <option value="EUR">EUR (€)</option>
                                    <option value="GBP">GBP (£)</option>
                                </select>
                            </div>
                            {formData.currency !== 'INR' && (
                                <div>
                                    <label className="block text-xs font-bold text-lekhya-primary uppercase mb-1">Exchange Rate</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        className="lekhya-input"
                                        value={formData.exchangeRate}
                                        onChange={(e) => setFormData({ ...formData, exchangeRate: parseFloat(e.target.value) })}
                                    />
                                </div>
                            )}

                            {/* Advanced Options & Mode */}
                            <div className="flex items-end pb-2 gap-4 justify-between w-full">
                                <label className="flex items-center gap-2 cursor-pointer select-none border border-slate-200 px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                                    <input
                                        type="checkbox"
                                        className="w-4 h-4 text-lekhya-accent rounded focus:ring-lekhya-accent"
                                        checked={formData.isOptional}
                                        onChange={(e) => setFormData({ ...formData, isOptional: e.target.checked })}
                                    />
                                    <span className="text-xs font-bold text-lekhya-primary uppercase">Optional (Memo)</span>
                                </label>

                                <div className="flex bg-slate-100 p-1 rounded-md border border-slate-200">
                                    <button
                                        type="button"
                                        onClick={() => setMode('ITEM')}
                                        className={cn("px-3 py-1.5 text-xs font-bold rounded-sm transition-all", mode === 'ITEM' ? "bg-white text-lekhya-primary shadow-sm" : "text-slate-500 hover:text-slate-700")}
                                    >
                                        Item Invoice
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setMode('ACCOUNTING')}
                                        className={cn("px-3 py-1.5 text-xs font-bold rounded-sm transition-all", mode === 'ACCOUNTING' ? "bg-white text-lekhya-primary shadow-sm" : "text-slate-500 hover:text-slate-700")}
                                    >
                                        Accounting Invoice
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* ITEM GRID */}
                        <div className="mt-8 border border-gray-300 rounded-sm overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full text-xs">
                                    <thead className="bg-[#E0E8F0] text-lekhya-primary font-bold border-b border-gray-300">
                                        <tr>
                                            <th className="px-2 py-2 text-left w-10">#</th>
                                            <th className="px-2 py-2 text-left w-48">Particulars</th>
                                            {mode === 'ITEM' && <th className="px-2 py-2 text-left w-24">HSN/SAC</th>}
                                            {mode === 'ITEM' && <th className="px-2 py-2 text-left w-24">Godown</th>}
                                            {mode === 'ITEM' && <th className="px-2 py-2 text-right w-20">Qty</th>}
                                            {mode === 'ITEM' && <th className="px-2 py-2 text-right w-24">Rate</th>}
                                            {mode === 'ITEM' && <th className="px-2 py-2 text-left w-16">Per</th>}
                                            <th className="px-2 py-2 text-right w-32">Amount</th>
                                            {/* Taxes */}
                                            <th className="px-2 py-2 text-right w-16">CGST %</th>
                                            <th className="px-2 py-2 text-right w-16">SGST %</th>
                                            <th className="px-2 py-2 text-right w-16">IGST %</th>
                                            <th className="px-2 py-2 text-right w-32">Total</th>
                                            <th className="px-2 py-2 w-10"></th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200 bg-white">
                                        {items.map((item, idx) => (
                                            <tr key={item.id} className="group hover:bg-blue-50">
                                                <td className="px-2 py-1 text-center text-slate-500">{idx + 1}</td>
                                                <td className="px-2 py-1">
                                                    <input
                                                        type="text"
                                                        list={mode === 'ITEM' ? "inventory-master-list" : "accounts-list"}
                                                        className="w-full bg-transparent border-none focus:ring-1 focus:ring-lekhya-primary p-1 rounded"
                                                        placeholder={mode === 'ITEM' ? "Item Name" : "Ledger Name"}
                                                        value={item.productName}
                                                        onChange={(e) => handleItemChange(item.id, 'productName', e.target.value)}
                                                    />
                                                    {mode === 'ITEM' ? (
                                                        <datalist id="inventory-master-list">
                                                            {inventoryMaster.map((inv: any) => (
                                                                <option key={inv.id} value={inv.name} />
                                                            ))}
                                                        </datalist>
                                                    ) : (
                                                        <datalist id="accounts-list">
                                                            {accounts.map((acc: any) => (
                                                                <option key={acc.id} value={acc.name} />
                                                            ))}
                                                        </datalist>
                                                    )}
                                                </td>
                                                {mode === 'ITEM' && (
                                                    <>
                                                        <td className="px-2 py-1">
                                                            <input
                                                                type="text"
                                                                className="w-full bg-transparent border-none focus:ring-1 focus:ring-lekhya-primary p-1 rounded text-center"
                                                                value={item.hsnSac}
                                                                onChange={(e) => handleItemChange(item.id, 'hsnSac', e.target.value)}
                                                            />
                                                        </td>
                                                        <td className="px-2 py-1">
                                                            <select
                                                                className="w-full bg-transparent border-none focus:ring-1 focus:ring-lekhya-primary p-1 rounded text-xs"
                                                                value={item.godownId || ''}
                                                                onChange={(e) => handleItemChange(item.id, 'godownId', e.target.value)}
                                                            >
                                                                <option value="">Main</option>
                                                                {godowns.map(g => <option key={g.id} value={g.id}>{g.name}</option>)}
                                                            </select>
                                                        </td>
                                                        <td className="px-2 py-1">
                                                            <input
                                                                type="number"
                                                                className="w-full bg-transparent border-none focus:ring-1 focus:ring-lekhya-primary p-1 rounded text-right font-medium"
                                                                value={item.qty || ''}
                                                                onChange={(e) => handleItemChange(item.id, 'qty', parseFloat(e.target.value))}
                                                            />
                                                        </td>
                                                        <td className="px-2 py-1">
                                                            <input
                                                                type="number"
                                                                className="w-full bg-transparent border-none focus:ring-1 focus:ring-lekhya-primary p-1 rounded text-right font-medium"
                                                                value={item.rate || ''}
                                                                onChange={(e) => handleItemChange(item.id, 'rate', parseFloat(e.target.value))}
                                                            />
                                                        </td>
                                                        <td className="px-2 py-1">
                                                            <input
                                                                type="text"
                                                                className="w-full bg-transparent border-none focus:ring-1 focus:ring-lekhya-primary p-1 rounded"
                                                                value={item.per}
                                                                onChange={(e) => handleItemChange(item.id, 'per', e.target.value)}
                                                            />
                                                        </td>
                                                    </>
                                                )}
                                                <td className="px-2 py-1">
                                                    {/* In Accounting Mode, Amount is editable. In Item Mode, it's calculated (mostly) but let's allow edit if needed or just display */}
                                                    {mode === 'ITEM' ? (
                                                        <div className="text-right font-mono text-slate-700 px-1">
                                                            {item.taxableAmount.toFixed(2)}
                                                        </div>
                                                    ) : (
                                                        <input
                                                            type="number"
                                                            className="w-full bg-transparent border-none focus:ring-1 focus:ring-lekhya-primary p-1 rounded text-right font-medium"
                                                            value={item.taxableAmount || ''}
                                                            onChange={(e) => {
                                                                const val = parseFloat(e.target.value);
                                                                // Update taxable amount directly
                                                                setItems(prev => prev.map(i => i.id === item.id ? {
                                                                    ...i,
                                                                    taxableAmount: val,
                                                                    // Trigger tax recalc 
                                                                    cgstAmount: round(val * (i.cgstRate / 100)),
                                                                    sgstAmount: round(val * (i.sgstRate / 100)),
                                                                    igstAmount: round(val * (i.igstRate / 100)),
                                                                    totalAmount: round(val + (val * (i.cgstRate / 100)) + (val * (i.sgstRate / 100)) + (val * (i.igstRate / 100)))
                                                                } : i));
                                                            }}
                                                        />
                                                    )}
                                                </td>
                                                <td className="px-2 py-1">
                                                    <input
                                                        type="number"
                                                        className="w-full bg-transparent border-none focus:ring-1 focus:ring-lekhya-primary p-1 rounded text-right text-xs"
                                                        value={item.cgstRate || ''}
                                                        onChange={(e) => handleItemChange(item.id, 'cgstRate', parseFloat(e.target.value))}
                                                    />
                                                </td>
                                                <td className="px-2 py-1">
                                                    <input
                                                        type="number"
                                                        className="w-full bg-transparent border-none focus:ring-1 focus:ring-lekhya-primary p-1 rounded text-right text-xs"
                                                        value={item.sgstRate || ''}
                                                        onChange={(e) => handleItemChange(item.id, 'sgstRate', parseFloat(e.target.value))}
                                                    />
                                                </td>
                                                <td className="px-2 py-1">
                                                    <input
                                                        type="number"
                                                        className="w-full bg-transparent border-none focus:ring-1 focus:ring-lekhya-primary p-1 rounded text-right text-xs"
                                                        value={item.igstRate || ''}
                                                        onChange={(e) => handleItemChange(item.id, 'igstRate', parseFloat(e.target.value))}
                                                    />
                                                </td>
                                                <td className="px-2 py-1 text-right font-bold font-mono text-lekhya-primary">
                                                    {item.totalAmount.toFixed(2)}
                                                </td>
                                                <td className="px-2 py-1 text-center">
                                                    <button onClick={() => removeItem(item.id)} className="text-slate-300 hover:text-red-500">
                                                        <Trash2 className="w-3 h-3" />
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot className="bg-gray-50 border-t border-gray-300">
                                        <tr>
                                            <td colSpan={mode === 'ITEM' ? 10 : 6} className="px-4 py-2 text-right font-bold text-slate-600 uppercase">Grand Total</td>
                                            <td className="px-2 py-2 text-right font-bold text-lg text-lekhya-primary">
                                                {formData.currency} {grandTotal.toFixed(2)}
                                            </td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <div className="p-2 border-t border-gray-200">
                                <button
                                    type="button"
                                    onClick={addItem}
                                    className="text-xs font-bold text-lekhya-primary hover:underline flex items-center gap-1"
                                >
                                    <Plus className="w-3 h-3" /> Add Item
                                </button>
                            </div>
                        </div>

                        {/* Narration */}
                        <div>
                            <label className="block text-xs font-bold text-lekhya-primary uppercase mb-1">
                                Narration (Remarks)
                            </label>
                            <textarea
                                className="lekhya-input min-h-[40px] py-1 italic text-slate-600"
                                placeholder="Enter accounting notes..."
                                value={formData.narration}
                                onChange={(e) => setFormData({ ...formData, narration: e.target.value })}
                            />
                        </div>

                        {/* TDS Section - Only for PAYMENT vouchers */}
                        {formData.type === 'PAYMENT' && (
                            <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                <h3 className="text-sm font-bold text-orange-800 mb-3">TDS (Tax Deducted at Source)</h3>

                                <div className="flex items-center gap-3 mb-4">
                                    <input
                                        type="checkbox"
                                        id="tdsApplicable"
                                        checked={formData.tdsApplicable}
                                        onChange={(e) => setFormData({ ...formData, tdsApplicable: e.target.checked })}
                                        className="w-4 h-4"
                                    />
                                    <label htmlFor="tdsApplicable" className="text-sm font-medium">
                                        TDS Applicable on this payment
                                    </label>
                                </div>

                                {formData.tdsApplicable && (
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-700 uppercase mb-1">TDS Section</label>
                                            <select
                                                className="lekhya-input"
                                                value={formData.tdsSectionId}
                                                onChange={(e) => setFormData({ ...formData, tdsSectionId: e.target.value })}
                                            >
                                                <option value="">Select Section...</option>
                                                {tdsSections.map((section: any) => (
                                                    <option key={section.id} value={section.id}>
                                                        {section.section} - {section.description}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Party PAN</label>
                                            <input
                                                type="text"
                                                className="lekhya-input uppercase"
                                                placeholder="ABCDE1234F"
                                                maxLength={10}
                                                value={formData.partyPAN}
                                                onChange={(e) => setFormData({ ...formData, partyPAN: e.target.value.toUpperCase() })}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-xs font-bold text-gray-700 uppercase mb-1">TDS Amount</label>
                                            <input
                                                type="number"
                                                className="lekhya-input bg-gray-100 font-bold text-orange-600"
                                                value={formData.tdsAmount}
                                                readOnly
                                            />
                                            <p className="text-xs text-gray-500 mt-1">Auto-calculated</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Cost Allocation Modal */}
                        {showCostCenterModal && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
                                    <h3 className="font-bold text-lg mb-4 text-lekhya-primary">Cost Allocations</h3>
                                    <div className="mb-4 p-3 bg-yellow-50 text-sm text-slate-700 rounded border border-yellow-200 flex justify-between">
                                        <span>Target Amount:</span>
                                        <span className="font-bold">{formData.amount}</span>
                                    </div>

                                    <div className="space-y-2 max-h-[300px] overflow-auto">
                                        {tempAllocations.map((alloc, idx) => (
                                            <div key={idx} className="flex gap-2">
                                                <select
                                                    className="lekhya-input flex-1"
                                                    value={alloc.costCenterId}
                                                    onChange={(e) => updateAllocation(idx, 'costCenterId', e.target.value)}
                                                >
                                                    <option value="">Select Cost Center</option>
                                                    {costCenters.map(cc => (
                                                        <option key={cc.id} value={cc.id}>{cc.name}</option>
                                                    ))}
                                                </select>
                                                <input
                                                    type="number"
                                                    className="lekhya-input w-32 text-right"
                                                    value={alloc.amount}
                                                    onChange={(e) => updateAllocation(idx, 'amount', parseFloat(e.target.value))}
                                                />
                                                <button type="button" onClick={() => removeAllocationRow(idx)} className="text-red-500 hover:text-red-700 p-2">
                                                    <Trash2 className="w-4 h-4" />
                                                </button>
                                            </div>
                                        ))}
                                    </div>

                                    <button type="button" onClick={addAllocationRow} className="mt-2 text-sm text-lekhya-accent hover:underline flex items-center gap-1">
                                        <Plus className="w-3 h-3" /> Add Row
                                    </button>

                                    <div className="flex justify-end gap-2 mt-6 border-t pt-4">
                                        <div className="mr-auto text-sm">
                                            <span>Total: </span>
                                            <span className={cn(
                                                "font-bold",
                                                Math.abs(tempAllocations.reduce((sum, a) => sum + (parseFloat(a.amount as any) || 0), 0) - formData.amount) < 0.01
                                                    ? "text-green-600"
                                                    : "text-red-600"
                                            )}>
                                                {tempAllocations.reduce((sum, a) => sum + (parseFloat(a.amount as any) || 0), 0)}
                                            </span>
                                        </div>
                                        <button
                                            type="button"
                                            onClick={() => setShowCostCenterModal(false)}
                                            className="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="button"
                                            onClick={saveAllocations}
                                            className="px-4 py-2 text-sm bg-lekhya-accent text-white rounded hover:bg-orange-600"
                                        >
                                            Save Allocations
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* TCS Section - Only for SALES vouchers */}
                        {formData.type === 'SALES' && (
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h3 className="text-sm font-bold text-blue-800 mb-3">TCS (Tax Collected at Source)</h3>

                                <div className="flex items-center gap-3 mb-4">
                                    <input
                                        type="checkbox"
                                        id="tcsApplicable"
                                        checked={formData.tcsApplicable}
                                        onChange={(e) => setFormData({ ...formData, tcsApplicable: e.target.checked })}
                                        className="w-4 h-4"
                                    />
                                    <label htmlFor="tcsApplicable" className="text-sm font-medium">
                                        TCS Applicable on this sale
                                    </label>
                                </div>

                                {formData.tcsApplicable && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Goods Type</label>
                                            <select
                                                className="lekhya-input"
                                                value={formData.tcsConfigId}
                                                onChange={(e) => setFormData({ ...formData, tcsConfigId: e.target.value })}
                                            >
                                                <option value="">Select Goods Type...</option>
                                                {tcsConfigs.map((config: any) => (
                                                    <option key={config.id} value={config.id}>
                                                        {config.goodsType} - {config.description}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-xs font-bold text-gray-700 uppercase mb-1">TCS Amount</label>
                                            <input
                                                type="number"
                                                className="lekhya-input bg-gray-100 font-bold text-blue-600"
                                                value={formData.tcsAmount}
                                                readOnly
                                            />
                                            <p className="text-xs text-gray-500 mt-1">Auto-calculated</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                </div>

                {/* Footer Actions */}
                <div className="p-4 border-t border-gray-300 bg-gray-50 flex items-center justify-between sticky bottom-0 z-10">
                    <div className="text-xs text-slate-500">
                        <span className="font-bold">Shortcuts:</span> Alt+S (Save), Alt+C (Create Ledger)
                    </div>
                    <div className="flex items-center gap-2">
                        <button
                            type="button"
                            onClick={() => {
                                // Save as Logic
                                const payload = { ...formData, amount: grandTotal, items, isRecurring: true, number: `TMP-${Math.floor(Math.random() * 1000)}` };
                                fetch('/api/vouchers', { method: 'POST', body: JSON.stringify(payload) });
                                alert('Saved as Template');
                            }}
                            className="bg-white border border-slate-300 text-slate-700 px-6 py-2.5 rounded hover:bg-slate-50 font-bold flex items-center gap-2 transition-transform active:scale-95"
                        >
                            <Save className="w-4 h-4" /> Save Template
                        </button>
                        <button
                            type="submit"
                            disabled={loading}
                            className={cn(
                                "bg-lekhya-accent text-lekhya-primary px-8 py-2.5 rounded font-bold flex items-center gap-2 transition-transform hover:scale-105 active:scale-95 shadow-md",
                                loading && "opacity-70 cursor-wait"
                            )}
                        >
                            <Save className="w-4 h-4" />
                            {loading ? 'Saving...' : 'Save Voucher'}
                        </button>
                    </div>
                </div>
            </form>
        </div>
        </div >

        {/* Footer shortcut hints */ }
        < div className = "bg-[#1A3E5C] text-white/70 text-xs py-1 px-4 fixed bottom-0 w-full flex justify-between z-20" >
            <div className="flex gap-4">
                <span><strong className="text-lekhya-accent">Esc</strong> Quit</span>
                <span><strong className="text-lekhya-accent">Ctrl+A</strong> Accept</span>
            </div>
        </div >
    </div >
    );
}
